# .github/workflows/merge-to-main.yml
name: Merge to Main - Branch Decision

on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  decide-branch:
    runs-on: ubuntu-latest
    outputs:
      only_lib: ${{ steps.detect.outputs.only_lib }}
      latest_release_branch: ${{ steps.latest.outputs.branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: detect
        with:
          filters: |
            lib:
              - 'lib/**'
            forbidden:
              - 'android/**'
              - 'pubspec.yaml'
              - 'shorebird.yaml'

      - name: Set only_lib output
        id: set
        run: |
          if [[ ${{ steps.detect.outputs.lib }} == 'true' && ${{ steps.detect.outputs.forbidden }} == 'false' ]]; then
            echo "only_lib=true"
          else
            echo "only_lib=false"
          fi >> $GITHUB_OUTPUT

      - name: Find latest release branch
        id: latest
        run: |
          # Get the most recent release/* branch by creation date
          BRANCH=$(git branch -r --sort=-committerdate | grep 'origin/release/' | head -n1 | sed 's|origin/||' | xargs || echo "")
          if [[ -z "$BRANCH" ]]; then
            echo "No existing release branch found. Will create new one."
            echo "branch=" >> $GITHUB_OUTPUT
          else
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          fi
          

      - name: Log Outputs
        run: |
          echo "only_lib: ${{ steps.detect.outputs.lib }}"
          echo "forbidden: ${{ steps.detect.outputs.forbidden }}"
          echo "branch: ${{ steps.latest.outputs.branch }}"
          echo "latest_release_branch: ${{ steps.latest.outputs.latest_release_branch }}"

  test-log-job:
    needs: decide-branch
    if: needs.decide-branch.outputs.only_lib == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: log outputs
        run: |
          echo "only_lib: ${{ steps.detect.outputs.lib }}"
          echo "forbidden: ${{ steps.detect.outputs.forbidden }}"
          echo "branch: ${{ steps.latest.outputs.branch }}"
          echo "latest_release_branch: ${{ steps.latest.outputs.latest_release_branch }}"

  push-to-existing-release:
    needs: decide-branch
    if: needs.decide-branch.outputs.only_lib == 'true' && needs.decide-branch.outputs.latest_release_branch != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Push to latest release branch
        run: |
          git push origin main:${{ needs.decide-branch.outputs.latest_release_branch }}

  create-new-release-branch:
    needs: decide-branch
    if: needs.decide-branch.outputs.only_lib == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get next version suggestion
        id: version
        run: |
          dart pub global activate bump
          SUGGESTED=$(bump suggest)
          BRANCH_NAME="release/v$SUGGESTED"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Suggested new branch: $BRANCH_NAME"

      - name: Create and push new release branch
        run: |
          git push origin main:refs/heads/${{ steps.version.outputs.branch }}