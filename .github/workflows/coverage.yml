name: Dart CI + Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      - name: Flutter FVM config action
        uses: kuhnroyal/flutter-fvm-config-action@v3.1

      - name: Setup Flutter ðŸ’»
        uses: subosito/flutter-action@v2.21.0
        id: setup-flutter
        with:
          flutter-version: ${{ steps.fvm-config.outputs.FLUTTER_VERSION }}
          cache: true
          cache-key: ${{ runner.os }}-flutter-${{ steps.fvm-config.outputs.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache Pub ðŸ’¾
        uses: actions/cache@v4
        with:
          path: |
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code (build_runner)
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Install grcov
        run: |
          curl -L https://github.com/mozilla/grcov/releases/latest/download/grcov-linux-x86_64.tar.bz2 | tar -xj
          sudo mv grcov /usr/local/bin/grcov

      - name: Run tests with coverage
        run: |
          flutter test --coverage --concurrency=12
          # This generates coverage/lcov.info automatically in Flutter â‰¥3.0

      # â† This step was missing in your version!
      - name: Generate lcov.info with grcov (only if you need extra filtering)
        run: |
          grcov coverage \
            --source-dir . \
            --binary-path . \
            --output-type lcov \
            --branch \
            --ignore-not-existing \
            --ignore "test/*" \
            --ignore "lib/generated/*" \
            > lcov.info
        continue-on-error: true   # optional: don't fail if grcov has warnings

      # - name: Upload coverage to Codecov (optional but recommended)
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: coverage/lcov.info   # Flutter already outputs this
      #     token: ${{ secrets.CODECOV_TOKEN }}   # only needed for private repos

      - name: Check minimum coverage (90%)
        run: |
          # Flutter already created coverage/lcov.info â†’ use it directly
          COVERAGE=$(grep -m1 "^lines" coverage/lcov.info | cut -d: -f2 | tr -d '% ')
          echo "Current coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 90% â€” failing CI"
            exit 1
          else
            echo "Coverage $COVERAGE% â€” good!"
          fi
