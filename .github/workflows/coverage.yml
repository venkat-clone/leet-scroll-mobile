name: Dart CI + Coverage
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Flutter FVM config action
        uses: kuhnroyal/flutter-fvm-config-action@v3.1
      - name: Setup Flutter ðŸ’»
        uses: subosito/flutter-action@v2.21.0
        id: setup-flutter
        with:
          flutter-version: ${{ steps.fvm-config.outputs.FLUTTER_VERSION }}
          cache: true
          cache-key: ${{ runner.os }}-flutter-${{ steps.fvm-config.outputs.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
      - name: Cache Pub ðŸ’¾
        uses: actions/cache@v4
        with:
          path: |
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Install dependencies
        run: flutter pub get
      - name: Generate code (build_runner)
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Run tests with coverage
        run: flutter test --coverage --concurrency=12
        # Generates coverage/lcov.info automaticallyâ€”no extra tools needed!
      # - name: Upload coverage to Codecov (optional)
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: coverage/lcov.info
      #     token: ${{ secrets.CODECOV_TOKEN }}  # Only for private repos
      - name: Check minimum coverage (90%)
        run: |
          # Use Flutter's built-in lcov.info
          COVERAGE=$(grep -m1 "^SF:" coverage/lcov.info -A 100 | grep -m1 "^end_of_record" -B 100 | grep "^DA:" | awk '{sum+=$2} END {if (NR>0) print (sum/NR)*100}' | awk '{printf "%.0f", $1}')
          # Fallback if no lines: 0%
          if [ -z "$COVERAGE" ]; then COVERAGE=0; fi
          echo "Current coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 90% â€” failing CI"
            exit 1
          else
            echo "Coverage $COVERAGE% â€” good!"
          fi